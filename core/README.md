# Core æ¨¡å—

æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ¨¡å—ï¼ŒåŒ…å«æ¡Œå® çš„ä¸»è¦åŠŸèƒ½ã€‚

---

## ğŸ”¥ é‡è¦è®¾è®¡åŸåˆ™ï¼šåå°å°ç¥¥ä¸ä¸»ç¨‹åºå°ç¥¥

### äººè®¾ä¸€è‡´æ€§åŸåˆ™

é¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ª"å°ç¥¥"è§’è‰²ï¼š

| è§’è‰²                    | æ–‡ä»¶                   | èŒè´£                  | å¯ç”¨å·¥å…·                       |
| ----------------------- | ---------------------- | --------------------- | ------------------------------ |
| **ä¸»ç¨‹åºå°ç¥¥**          | `response_handler.py`  | å®é™…å¯¹è¯ã€ç”Ÿæˆå›å¤    | `tools/registry.py`            |
| **åå°å°ç¥¥ (ä¸»åŠ¨èŠå¤©)** | `proactive_chat.py`    | åˆ¤æ–­æ˜¯å¦ä¸»åŠ¨è¯´è¯/è¿½é—® | `ADJUST_INTERVAL`              |
| **åå°å°ç¥¥ (çŸ¥è¯†ç›‘æ§)** | `knowledge_monitor.py` | ç®¡ç†è®°å¿†/çŸ¥è¯†åº“       | `ADD/UPDATE/DELETE/BOOST/SKIP` |
| **åå°å°ç¥¥ (è®°å¿†å®¡æ ¸)** | `memory_reviewer.py`   | å®¡æ ¸è®°å¿†å‡çº§/åˆ é™¤     | `SEARCH/PROMOTE/KEEP/DELETE`   |

**æ ¸å¿ƒåŸåˆ™ï¼š**

1. **æ‰€æœ‰å°ç¥¥çš„äººè®¾å¿…é¡»å®Œå…¨ä¸€è‡´ï¼**
2. **ä¸åŒæ¨¡å—çš„å·¥å…·ä¸èƒ½æ··ç”¨ï¼**

### å·¥å…·ç®¡ç†

å·¥å…·å®šä¹‰åœ¨ `background_prompt.py` çš„ `BackgroundToolRegistry` ç±»ä¸­ï¼š

```python
from core.background_prompt import BackgroundToolRegistry

# ä¸»åŠ¨èŠå¤©å·¥å…·
tools = BackgroundToolRegistry.get_proactive_chat_tools_section()

# çŸ¥è¯†ç›‘æ§å·¥å…·
tools = BackgroundToolRegistry.get_knowledge_monitor_tools_section()

# è®°å¿†å®¡æ ¸å·¥å…·
tools = BackgroundToolRegistry.get_memory_reviewer_tools_section()
```

### äººè®¾æ¥æº

ä¸»ç¨‹åºå°ç¥¥çš„å®Œæ•´äººè®¾å®šä¹‰åœ¨ï¼š[llm/character_prompt.py](../llm/character_prompt.py)

---

## æ¨¡å—ç»“æ„

```
core/
â”œâ”€â”€ pet.py                # ä¸»å…¥å£ï¼Œåè°ƒå„ç»„ä»¶
â”œâ”€â”€ response_handler.py   # å“åº”å¤„ç†ï¼ŒLLM è°ƒç”¨
â”œâ”€â”€ proactive_chat.py     # ä¸»åŠ¨èŠå¤©/è¿½é—®åˆ¤æ–­
â”œâ”€â”€ knowledge_monitor.py  # çŸ¥è¯†åº“ç®¡ç†
â”œâ”€â”€ memory_reviewer.py    # è®°å¿†å®¡æ ¸
â”œâ”€â”€ background_prompt.py  # åå°äººè®¾ + å·¥å…·æ³¨å†Œè¡¨
â””â”€â”€ audio_queue.py        # éŸ³é¢‘é˜Ÿåˆ—ç®¡ç†
```

---

## âš ï¸ è¡€æ³ªæ•™è®­ï¼šå¸¸è§è®¾è®¡é”™è¯¯

**ä»¥ä¸‹æ˜¯å®é™…å¼€å‘ä¸­çŠ¯è¿‡çš„ä¸¥é‡é”™è¯¯ï¼Œå¿…é¡»é¿å…é‡è¹ˆè¦†è¾™ï¼**

---

### é”™è¯¯ 1ï¼šè¿½é—®åˆ¤æ–­æ—¶æœºé”™è¯¯â€”â€”æ’­æ”¾å®Œæ‰åˆ¤æ–­

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šå…ˆæ’­æ”¾å®ŒéŸ³é¢‘ï¼Œå†åˆ¤æ–­è¿½é—®
await self._play_audio_queue()
asyncio.create_task(manager.analyze_follow_up(...))  # æ’­æ”¾å®Œæ‰å¼€å§‹åˆ¤æ–­
```

**é—®é¢˜**ï¼š

- è¿½é—®åˆ¤æ–­éœ€è¦è°ƒç”¨ LLMï¼ˆçº¦ 1-2 ç§’ï¼‰
- è¿½é—®å†…å®¹ç”Ÿæˆä¹Ÿéœ€è¦è°ƒç”¨ LLMï¼ˆå† 1-2 ç§’ï¼‰
- åŠ ä¸Šé…ç½®çš„å»¶è¿Ÿæ—¶é—´ï¼ˆ2-4 ç§’ï¼‰
- æ€»è®¡éœ€è¦ 4-8 ç§’ï¼Œç”¨æˆ·æ—©å°±å¼€å§‹æ–°å¯¹è¯äº†

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šæ’­æ”¾éŸ³é¢‘å’Œè¿½é—®åˆ¤æ–­å¹¶è¡Œæ‰§è¡Œ
follow_up_task = asyncio.create_task(self._handle_follow_up(...))  # å¹¶è¡Œå¯åŠ¨
await self._play_audio_queue()  # æ’­æ”¾éŸ³é¢‘
await follow_up_task  # ç­‰å¾…è¿½é—®å®Œæˆ
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**æ’­æ”¾æœŸé—´å°±å¼€å§‹åˆ¤æ–­è¿½é—® + ç”Ÿæˆå†…å®¹ï¼Œè¿½é—®å†…å®¹ç”Ÿæˆåç­‰å¾…å»¶è¿Ÿå†è¿½åŠ åˆ°é˜Ÿåˆ—**

---

### é”™è¯¯ 2ï¼šå¿˜è®°é…ç½®ä¸­çš„å»¶è¿Ÿå‚æ•°

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šè¿½é—®å†…å®¹ç”Ÿæˆåç«‹åˆ»è¿½åŠ åˆ°é˜Ÿåˆ—
segments = self._split_by_emotion(follow_up_response)
for emotion, text in segments:
    self.audio_queue.submit(chunk, ...)  # ç«‹åˆ»è¿½åŠ ï¼Œæ²¡æœ‰å»¶è¿Ÿï¼
```

**é—®é¢˜**ï¼š

- `config.py` ä¸­æ˜ç¡®å®šä¹‰äº† `FOLLOW_UP_DELAY_MIN = 2` å’Œ `FOLLOW_UP_DELAY_MAX = 4`
- è¿½é—®åº”è¯¥æœ‰ä¸€ä¸ªè‡ªç„¶çš„åœé¡¿ï¼Œä¸æ˜¯æœºæ¢°åœ°ç«‹åˆ»æ¥ä¸Š
- ç›´æ¥å¿½ç•¥é…ç½®å‚æ•°æ˜¯ä¸¥é‡çš„è®¾è®¡å¤±è¯¯

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šç­‰å¾…é…ç½®çš„å»¶è¿Ÿæ—¶é—´
delay = random.randint(config.FOLLOW_UP_DELAY_MIN, config.FOLLOW_UP_DELAY_MAX)
await asyncio.sleep(delay)
# å†è¿½åŠ åˆ°é˜Ÿåˆ—
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**æ‰€æœ‰å¯é…ç½®å‚æ•°éƒ½æœ‰å…¶å­˜åœ¨æ„ä¹‰ï¼Œä¸è¦æ“…è‡ªå¿½ç•¥**

---

### é”™è¯¯ 3ï¼šæœç´¢çŸ¥è¯†åº“æ—¶ä½¿ç”¨å ä½ç¬¦

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šuser_text å¯èƒ½æ˜¯å ä½ç¬¦ "[è¯­éŸ³è¾“å…¥]"
self._last_retrieved_memories = kb.search_by_text_raw(user_text, n_results=5)
```

**é—®é¢˜**ï¼š

- Voice-to-LLM æ¨¡å¼ä¸‹ï¼Œ`user_text` è¢«è®¾ç½®ä¸º `[è¯­éŸ³è¾“å…¥]` å ä½ç¬¦
- ç”¨å ä½ç¬¦æœç´¢çŸ¥è¯†åº“æ¯«æ— æ„ä¹‰ï¼Œè¿˜ä¼šäº§ç”Ÿè¯¯å¯¼æ€§æ—¥å¿— `æœç´¢ '[è¯­éŸ³è¾“å…¥]'`

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯å ä½ç¬¦
if user_text and user_text not in ["[è¯­éŸ³è¾“å…¥]", ""]:
    self._last_retrieved_memories = kb.search_by_text_raw(user_text, n_results=5)
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**å¤„ç†è¾“å…¥æ—¶å¿…é¡»è€ƒè™‘æ‰€æœ‰å¯èƒ½çš„è¾¹ç•Œæƒ…å†µ**

---

### é”™è¯¯ 4ï¼šé”™è¯¯åˆ†æé—®é¢˜æ ¹å› â€”â€”æ‰¾å€Ÿå£è€Œéè§£å†³é—®é¢˜

**é”™è¯¯åˆ†æ**ï¼š

> "è¿½é—®åˆ¤æ–­çš„ LLM è°ƒç”¨å¤ªæ…¢ï¼ˆçº¦ 58 ç§’æ‰å®Œæˆï¼‰"

**é—®é¢˜**ï¼š

- API è°ƒç”¨å®é™…åªéœ€è¦ä¸åˆ° 2 ç§’
- 58 ç§’æ˜¯ç”¨æˆ·ç­‰å¾…æ—¶é—´ï¼Œä¸æ˜¯ API å»¶è¿Ÿ
- è¿™æ˜¯åœ¨æ‰¾å€Ÿå£æ¨å¸è´£ä»»ï¼Œè€Œä¸æ˜¯åˆ†æçœŸæ­£çš„è®¾è®¡é—®é¢˜

**æ­£ç¡®åˆ†æ**ï¼š

- è¿½é—®åˆ¤æ–­åœ¨éŸ³é¢‘æ’­æ”¾**ä¹‹å**æ‰å¼€å§‹ï¼Œæ—¶åºè®¾è®¡æœ‰é—®é¢˜
- åº”è¯¥å¹¶è¡Œå¤„ç†ï¼šæ’­æ”¾æœŸé—´å°±å¼€å§‹åˆ¤æ–­

**æ ¸å¿ƒåŸåˆ™**ï¼š**å‡ºç°é—®é¢˜æ—¶å…ˆæ£€æŸ¥è‡ªå·±çš„è®¾è®¡ï¼Œä¸è¦ç¬¬ä¸€æ—¶é—´æ€ªå¤–éƒ¨å› ç´ **

---

### é”™è¯¯ 5ï¼šå·¥å…·æè¿°å†™æ­»åœ¨ prompt ä¸­

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šå·¥å…·æè¿°ç¡¬ç¼–ç åœ¨ prompt å­—ç¬¦ä¸²ä¸­
SYSTEM_PROMPT = """ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œï¼š
- [ADD] å†…å®¹ â†’ æ·»åŠ æ–°è®°å¿†
- [UPDATE:è®°å¿†ID] æ–°å†…å®¹ â†’ æ›´æ–°å·²æœ‰è®°å¿†
..."""
```

**é—®é¢˜**ï¼š

- æ·»åŠ /ä¿®æ”¹å·¥å…·æ—¶éœ€è¦ä¿®æ”¹å¤šä¸ªæ–‡ä»¶
- å®¹æ˜“é—æ¼æŸäº›æ–‡ä»¶ï¼Œå¯¼è‡´ä¸ä¸€è‡´
- ä¸åŒæ¨¡å—å¯èƒ½æ„å¤–å…±äº«å·¥å…·ï¼ˆå·¥å…·æ··ç”¨ï¼‰

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šå·¥å…·æ³¨å†Œè¡¨ç»Ÿä¸€ç®¡ç†
from core.background_prompt import BackgroundToolRegistry

def get_system_prompt(cls) -> str:
    tools_section = BackgroundToolRegistry.get_knowledge_monitor_tools_section()
    return f"""{PERSONA}
{tools_section}
..."""
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**DRYï¼ˆDon't Repeat Yourselfï¼‰ï¼Œé›†ä¸­ç®¡ç†å¯å˜é…ç½®**

---

## å…³é”®é…ç½®

ä¸»åŠ¨èŠå¤©ç›¸å…³é…ç½®åœ¨ `config.py`ï¼š

```python
PROACTIVE_CHECK_INTERVAL_MIN = 30   # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
PROACTIVE_CHECK_INTERVAL_MAX = 90
PROACTIVE_MIN_IDLE_TIME = 20        # æœ€å°ç©ºé—²æ—¶é—´
FOLLOW_UP_DELAY_MIN = 2             # è¿½é—®å»¶è¿Ÿæœ€å°å€¼
FOLLOW_UP_DELAY_MAX = 4             # è¿½é—®å»¶è¿Ÿæœ€å¤§å€¼
```

**æ³¨æ„**ï¼šå·²ç§»é™¤ `PROACTIVE_CHAT_CHANCE` ç­‰æœºæ¢°æ¦‚ç‡å‚æ•°ï¼Œç°åœ¨å®Œå…¨ç”±åå°å°ç¥¥ï¼ˆLLMï¼‰åˆ¤æ–­ã€‚

---

## âš ï¸ è®°å¿†ç³»ç»Ÿè®¾è®¡é”™è¯¯

### é”™è¯¯ 6ï¼šç”¨ç¡¬æ€§æ•°å€¼åˆ¤æ–­ core è®°å¿†

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šimportance >= 3.0 å°±è‡ªåŠ¨æˆä¸º core
if category == "core" or importance >= 3.0:
    continue  # æ°¸ä¸è¡°å‡
```

**é—®é¢˜**ï¼š

- è¿ç»­å¯¹è¯ 10 æ¬¡è°ˆåˆ°ä¸€ä¸ªè¯é¢˜ï¼Œimportance å°±ä¼šè¾¾åˆ° 3.0
- ä½†"æœ€è¿‘èŠå¾—å¤š"â‰ "é•¿æœŸé‡è¦çš„æ ¸å¿ƒäº‹å®"
- æœºæ¢°è§„åˆ™æ— æ³•åŒºåˆ†"ä¸´æ—¶çƒ­ç‚¹è¯é¢˜"å’Œ"çœŸæ­£é‡è¦çš„äº‹å®"

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šåªçœ‹ categoryï¼Œç”±åå°å°ç¥¥æ˜¾å¼æ ‡è®°
if category == "core":  # åå°å°ç¥¥é€šè¿‡ [PROMOTE] æ ‡è®°
    continue

# importance è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œè§¦å‘åå°å°ç¥¥å®¡æ ¸
if new_importance >= self.PROMOTE_THRESHOLD:
    self._schedule_promotion_review(memory)
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**æ•°å€¼åªæ˜¯è§¦å‘æ¡ä»¶ï¼Œæœ€ç»ˆåˆ¤æ–­å¿…é¡»ç”± LLM å®Œæˆ**

---

### é”™è¯¯ 7ï¼šå®¡æ ¸åˆ¤æ–­ä¸è®¾å†·å´æœŸ/æ·˜æ±°æ ‡è®°

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šæ¯æ¬¡ importance è¾¾åˆ°é˜ˆå€¼å°±è§¦å‘å®¡æ ¸
if new_importance >= self.PROMOTE_THRESHOLD:
    self._schedule_promotion_review(memory)  # åå¤è§¦å‘ï¼
```

**é—®é¢˜**ï¼š

- åå°å°ç¥¥åˆ¤æ–­"ä¸å‡çº§"åï¼Œä¸‹æ¬¡ BOOST åˆä¼šè§¦å‘å®¡æ ¸
- åŒä¸€æ¡è®°å¿†å¯èƒ½è¢«åå¤å®¡æ ¸ N æ¬¡ï¼Œæµªè´¹èµ„æº
- åå°å°ç¥¥çš„å†³ç­–æ²¡æœ‰è¢«è®°ä½

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šè®¾ç½®æ·˜æ±°æ ‡è®°ï¼Œæ°¸ä¸å†å®¡æ ¸
if decision == "KEEP":
    self._set_promotion_rejected(memory["id"])  # æ ‡è®°ä¸ºå·²æ·˜æ±°

# æ£€æŸ¥æ—¶è·³è¿‡å·²æ·˜æ±°çš„
if metadata.get("promotion_rejected", False):
    continue  # ä¸å†è§¦å‘å‡çº§å®¡æ ¸
```

**åŒç†ï¼Œè¡°å‡å®¡æ ¸ä¹Ÿéœ€è¦å†·å´æœŸ**ï¼š

```python
# âœ… æ­£ç¡®ï¼šè®¾ç½®å†·å´æœŸï¼Œ24 å°æ—¶å†…ä¸å†å®¡æ ¸
if decision == "KEEP":
    metadata["delete_cooldown_until"] = time.time() + 24 * 3600
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**LLM çš„åˆ¤æ–­ç»“æœå¿…é¡»è¢«è®°ä½å¹¶æŒä¹…åŒ–ï¼Œé¿å…é‡å¤åŠ³åŠ¨**

---

### é”™è¯¯ 8ï¼šæ‰“æ–­åçŠ¶æ€æœªæ­£ç¡®é‡ç½®

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šæ‰“æ–­åªæ¸…ç©ºé˜Ÿåˆ—ï¼Œä¸é€šçŸ¥ ResponseHandler
def interrupt(self):
    self.player.clear()
    self._was_interrupted = True
    # ResponseHandler è¿˜åœ¨ç»§ç»­å¤„ç†...
```

**é—®é¢˜**ï¼š

- ç”¨æˆ·æ‰“æ–­åï¼ŒResponseHandler ä»åœ¨ç»§ç»­å¤„ç†ï¼ˆè°ƒç”¨ LLMã€ç”Ÿæˆ TTSï¼‰
- æ–°è¯·æ±‚å¼€å§‹æ—¶ï¼Œä¸Šä¸€ä¸ªè¯·æ±‚çš„ \_cancelled æ ‡å¿—æ²¡é‡ç½®
- å¯¼è‡´æ–°è¯·æ±‚ä¹Ÿè¢«è¯¯åˆ¤ä¸º"å·²å–æ¶ˆ"

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šæ‰“æ–­æ—¶é€šçŸ¥ ResponseHandler
def interrupt(self):
    self.player.clear()
    self._was_interrupted = True
    if self.response_handler:
        self.response_handler.cancel()  # é€šçŸ¥å–æ¶ˆ

# âœ… æ­£ç¡®ï¼šæ–°è¯·æ±‚å¼€å§‹æ—¶é‡ç½®æ ‡å¿—
def process_user_speech(self, audio):
    self.response_handler.reset_cancellation()  # é‡ç½®ï¼
    # ...
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**çŠ¶æ€æœºçš„çŠ¶æ€å˜æ›´å¿…é¡»é€šçŸ¥æ‰€æœ‰ç›¸å…³ç»„ä»¶**

---

### é”™è¯¯ 9ï¼šget_recent_context æˆªå–è¿‡å°‘

**é”™è¯¯è®¾è®¡**ï¼š

```python
# âŒ é”™è¯¯ï¼šåªå–æœ€è¿‘ 4 æ¡ï¼Œè¿˜æˆªæ–­å†…å®¹
recent = self.conversation_history[-4:]
for msg in recent:
    content = msg["content"][:30] + "..."  # åªå– 30 å­—ç¬¦ï¼
```

**é—®é¢˜**ï¼š

- åå°å°ç¥¥éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡æ‰èƒ½åšå‡ºå‡†ç¡®åˆ¤æ–­
- æˆªæ–­åçš„å†…å®¹å¯èƒ½ä¸¢å¤±å…³é”®ä¿¡æ¯
- "ä¸»äººè¯´ï¼šæˆ‘æ˜å¤©è¦..." â†’ çœ‹ä¸å‡ºè¦å¹²ä»€ä¹ˆ

**æ­£ç¡®è®¾è®¡**ï¼š

```python
# âœ… æ­£ç¡®ï¼šè¿”å›å®Œæ•´å¯¹è¯å†å²
for msg in self.conversation_history:
    role = "ä¸»äºº" if msg["role"] == "user" else "ä½ "
    lines.append(f"{role}: {msg['content']}")  # å®Œæ•´å†…å®¹
return "\n".join(lines)
```

**æ ¸å¿ƒåŸåˆ™**ï¼š**ç»™ LLM çš„ä¸Šä¸‹æ–‡è¦å®Œæ•´ï¼Œä¸è¦è‡ªä½œä¸»å¼ æˆªæ–­**
