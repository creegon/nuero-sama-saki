# 记忆系统设计文档

本文档记录了记忆系统的设计思路、架构决策和实现细节，供未来参考。

---

## 设计动机

### 问题分析

原始记忆系统存在以下问题：

1. **记忆纠错困难**：用户纠正错误信息后，AI 无法有效更新记忆
2. **重要性判定不准**：top-k 检索后直接增加 importance，不管是否真正相关
3. **对话历史丢失**：超过阈值后直接截断，信息丢失
4. **`last_chat.json` 简陋**：只保存一条摘要，没有历史

### 核心洞察

基于对 Neuro-sama 记忆机制的调研，得出关键结论：

> **记忆判断是复杂的，不应靠机械规则，而应交给 LLM 判断。**

例如：

- "主人十天前很紧张" 和 "主人现在很放松" 不冲突，是时间变化
- 检索到 "主人喜欢猫"，AI 在聊天气 → 不算使用
- 检索到 "主人很紧张"，AI 说 "别这么绷着" → 算使用

---

## 三层记忆架构

```
┌─────────────────────────────────────────────────────────────────┐
│  层级 1: 工作记忆 (Working Memory)                                │
│  存储: conversation_history (内存, 30条/15轮)                     │
│  内容: 原始对话消息                                                │
│  生命周期: 当前会话                                                │
└────────────────────────────────↓────────────────────────────────┘
                         超过 30 条时摘要
┌─────────────────────────────────────────────────────────────────┐
│  层级 2: 情境记忆 (Episodic Memory)                               │
│  存储: 知识库 (category="episode")                                │
│  内容: 对话摘要 "[2026-01-03 18:00] 聊了面试、游戏"                │
│  生命周期: 7天快速衰减(×0.8)，14天删除                             │
│  用途: 回答 "刚才/昨天/上次聊了什么"                                │
└────────────────────────────────↓────────────────────────────────┘
                         后台小祥提取事实
┌─────────────────────────────────────────────────────────────────┐
│  层级 3: 事实记忆 (Semantic Memory)                               │
│  存储: 知识库 (category="fact" 或 "core")                        │
│  内容: "主人喜欢拉面"、"主人生日是X月X日"                          │
│  生命周期:                                                        │
│    - fact: 7天后衰减(×0.95)，importance<0.3 时删除               │
│    - core: 永不衰减 (importance>=3.0)                            │
│  用途: 回答 "你知道我XX吗"                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 职责分配

| 模块                          | 职责                                | 触发时机        |
| ----------------------------- | ----------------------------------- | --------------- |
| `ResponseHandler`             | 维护 `conversation_history`         | 每轮对话        |
| `ConversationSummarizer`      | 生成情境摘要 → `category="episode"` | 历史超过 30 条  |
| `KnowledgeMonitor` (后台小祥) | 提取事实 → `category="fact"`        | 每轮对话后      |
| `MemoryManager`               | 衰减和删除                          | 定时任务        |
| `MemoryInjector`              | 注入记忆到 prompt                   | 每次构建 prompt |

---

## 后台小祥 (KnowledgeMonitor)

后台小祥是一个独立的 LLM 调用，扮演"小祥的后台程序"角色，负责：

### 输入

- 当前对话: `主人: xxx` / `小祥: xxx`
- 检索到的记忆 (包含 ID): `[mem_123] 主人喜欢寿司`

### 可执行的操作

```
[ADD] 内容           → 添加新的事实记忆 (category="fact")
[UPDATE:mem_id] 内容 → 更新已有记忆 (删旧加新)
[BOOST:mem_id]       → 增加重要性 +0.3 (记忆被真正使用)
[DELETE:mem_id]      → 删除错误/过时记忆
[SKIP]               → 不做任何操作
```

### 判断原则

1. 两条信息看似冲突不一定要删除，可能只是时间变化
2. 如果检索到的记忆**真正影响了小祥的回复**，才算被使用
3. 主人纠正了错误记忆时，需要删除旧的、添加新的

---

## 记忆 Metadata 结构

```python
{
    "importance": 1.5,        # 重要性评分
    "timestamp": 1234567890,  # 创建时间
    "last_access": 1234567890,  # 最后访问时间

    # 分类
    "category": "fact",  # system | core | fact | episode

    # 来源和验证
    "source": "background_ai",  # user | background_ai | system
    "verified": False,  # True=用户确认, False=AI推断
}
```

---

## 衰减规则

| category                | 衰减系数     | 删除条件         |
| ----------------------- | ------------ | ---------------- |
| `system`                | 永不衰减     | 永不删除         |
| `core` / importance≥3.0 | 永不衰减     | 永不删除         |
| `episode`               | 7 天后 ×0.8  | 14 天后强制删除  |
| `fact`                  | 7 天后 ×0.95 | importance < 0.3 |

---

## 关键设计决策

### 1. 为什么删除 `last_chat.json`？

- 只能保存一条摘要，没有历史
- 无法语义检索
- 改用知识库统一存储 `episode`，可以：
  - 保存多条历史摘要
  - 语义检索 "上次聊游戏是什么时候"
  - 统一使用衰减机制

### 2. 为什么用 LLM 判断而非机械规则？

- 距离阈值只能判断语义相似，不能判断"是否真正使用"
- 两条冲突信息可能是时间变化，不应机械删除
- LLM 可以理解上下文，做出更准确的判断

### 3. 情境记忆 vs 事实记忆的区别

| 类型     | 例子                | 存储方式                         |
| -------- | ------------------- | -------------------------------- |
| 情境记忆 | "10 分钟前聊了面试" | 由 `ConversationSummarizer` 生成 |
| 事实记忆 | "主人明天要面试"    | 由 `KnowledgeMonitor` 提取       |

---

## 文件结构

```
core/
├── conversation_summarizer.py  # 对话摘要生成器
├── knowledge_monitor.py        # 后台小祥
├── memory_injector.py          # 记忆注入到 prompt
└── response_handler.py         # 集成摘要触发

knowledge/
├── __init__.py                 # KnowledgeBase 主类
├── memory_manager.py           # 衰减逻辑
└── retrieval.py                # 检索逻辑
```

---

## 未来改进方向

1. **定时衰减任务**：目前衰减需要手动调用，可以添加定时任务
2. **主题标签**：添加 `topic` 字段分类记忆 (preference, personal, memory, promise)

---

## 记忆审核机制 (MemoryReviewer)

### 触发条件

| 场景         | 触发条件                 | 审核任务            |
| ------------ | ------------------------ | ------------------- |
| **升级审核** | importance 达到 2.5      | 判断是否升级为 core |
| **衰减审核** | importance 降到 0.5 以下 | 判断是删除还是保留  |

### 工作流程

```
1. importance 达到临界值
   ↓
2. 调用 MemoryReviewer，传入：
   - 待审核的记忆
   - 相关记忆（语义检索 top-5）
   ↓
3. 思维链分析（最多 3 轮）：
   - 可以使用 [SEARCH:关键词] 搜索更多记忆
   - 最终决策：[PROMOTE] / [KEEP] / [DELETE]
   ↓
4. 执行决策
```

### 升级审核 Prompt 要点

- **什么是核心记忆**：长期稳定的重要事实
  - 主人的姓名、生日
  - 长期稳定的喜好
  - 重要约定
- **什么不是核心记忆**：
  - 临时状态 ("主人今天很累")
  - 短期计划
  - 只是最近话题多，但不是长期事实

### 衰减审核 Prompt 要点

- 这条记忆是否还有价值？
- 是否有更新的记忆替代了它？
- 删除它会不会让小祥"忘记"重要的事？

### 决策执行

| 决策    | 升级审核          | 衰减审核               |
| ------- | ----------------- | ---------------------- |
| PROMOTE | category → "core" | -                      |
| KEEP    | 保持不变          | 重置 importance 到 0.5 |
| DELETE  | 删除记忆          | 删除记忆               |
